{% extends 'layout.html' %}
{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –¥–ª—è "{{ container_name }}"</h5>
                <small class="text-muted">–°—Ç–∞—Ç—É—Å: <span class="badge bg-{{ 'success' if container_status == 'running' else 'secondary' }}">{{ container_status }}</span></small>
            </div>
            <div class="card-body">
                <form method="post" id="commandsForm">
                    <div class="mb-3">
                        <label for="launch_command" class="form-label">üöÄ <strong>–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</strong></label>
                        <textarea class="form-control font-monospace" id="launch_command" name="launch_command" rows="3" placeholder="docker start {{ container_name }}">{{ commands.launch_command or '' }}</textarea>
                        <div class="form-text">–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π <code>docker start</code>. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –ª–æ–≥–∏–∫—É –∑–∞–ø—É—Å–∫–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="start_command" class="form-label">‚ö° <strong>–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</strong></label>
                        <textarea class="form-control font-monospace" id="start_command" name="start_command" rows="3" placeholder="docker exec {{ container_name }} python main.py">{{ commands.start_command or '' }}</textarea>
                        <div class="form-text">–ö–æ–º–∞–Ω–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ü–û–°–õ–ï –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∞–º–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="stop_command" class="form-label">‚èπÔ∏è <strong>–ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏</strong></label>
                        <textarea class="form-control font-monospace" id="stop_command" name="stop_command" rows="3" placeholder="docker exec {{ container_name }} pkill -f python">{{ commands.stop_command or '' }}</textarea>
                        <div class="form-text">–ö–æ–º–∞–Ω–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ü–ï–†–ï–î –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="restart_command" class="form-label">üîÑ <strong>–ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</strong></label>
                        <textarea class="form-control font-monospace" id="restart_command" name="restart_command" rows="3" placeholder="docker restart {{ container_name }}">{{ commands.restart_command or '' }}</textarea>
                        <div class="form-text">–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π docker restart. –ú–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-success btn-lg w-100">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã</button>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('reset_bot_commands', name=container_name) }}" class="btn btn-warning btn-lg w-100" onclick="return confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º?')">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã</a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg w-100">‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">üí° –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥</h6>
            </div>
            <div class="card-body">
                <h6>üöÄ –ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:</h6>
                <code class="d-block mb-2">docker start {{ container_name }}</code>
                <code class="d-block mb-2">docker start --attach {{ container_name }}</code>
                <code class="d-block mb-3">docker run --rm -d --name {{ container_name }} myimage:latest</code>
                
                <h6>‚ö° –ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</h6>
                <code class="d-block mb-2">docker exec {{ container_name }} python main.py</code>
                <code class="d-block mb-2">docker exec {{ container_name }} npm start</code>
                <code class="d-block mb-3">docker exec {{ container_name }} ./start.sh</code>
                
                <h6>‚èπÔ∏è –ö–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:</h6>
                <code class="d-block mb-2">docker exec {{ container_name }} pkill python</code>
                <code class="d-block mb-2">docker exec {{ container_name }} killall node</code>
                <code class="d-block mb-3">docker stop {{ container_name }}</code>
                
                <h6>üîÑ –ö–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:</h6>
                <code class="d-block mb-2">docker restart {{ container_name }}</code>
                <code class="d-block mb-2">docker exec {{ container_name }} supervisorctl restart all</code>
                
                <div class="alert alert-info mt-3">
                    <small><strong>üí° –°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é <code>{{ "{{" }} container_name {{ "}}" }}</code> –≤ –∫–æ–º–∞–Ω–¥–∞—Ö –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.</small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">üîç –¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="testCommand('launch')">üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="testCommand('start')">‚ö° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="testCommand('stop')">‚èπÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É</button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="testCommand('restart')">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É</button>
                </div>
                <div id="testOutput" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
function testCommand(action) {
    const commands = {
        launch: document.getElementById('launch_command').value,
        start: document.getElementById('start_command').value,
        stop: document.getElementById('stop_command').value,
        restart: document.getElementById('restart_command').value
    };
    
    const command = commands[action];
    if (!command.trim()) {
        document.getElementById('testOutput').innerHTML = 
            '<div class="alert alert-warning">–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.</div>';
        return;
    }
    
    document.getElementById('testOutput').innerHTML = 
        '<div class="alert alert-info">üîç –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞:<br><code>' + command + '</code></div>';
    
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –≤—ã–∑–æ–≤ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    fetch(`/api/bot/{{ container_name }}/test-command`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: action, command: command})
    })
    .then(response => response.json())
    .then(data => {
        const alertClass = data.success ? 'alert-success' : 'alert-danger';
        document.getElementById('testOutput').innerHTML = 
            `<div class="alert ${alertClass}">${data.message}</div>`;
    })
    .catch(error => {
        document.getElementById('testOutput').innerHTML = 
            '<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error + '</div>';
    });
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('commandsForm');
    const inputs = form.querySelectorAll('textarea');
    
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            const saveBtn = form.querySelector('button[type="submit"]');
            saveBtn.classList.add('btn-warning');
            saveBtn.classList.remove('btn-success');
            saveBtn.innerHTML = '‚ö†Ô∏è –ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        });
    });
    
    form.addEventListener('submit', function() {
        const saveBtn = form.querySelector('button[type="submit"]');
        saveBtn.classList.add('btn-success');
        saveBtn.classList.remove('btn-warning');
        saveBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã';
    });
});
</script>
{% endblock %}