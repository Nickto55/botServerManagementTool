{% extends 'layout.html' %}
{% block content %}

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–∞–±–æ–≤ -->
<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="workspaces-tab" data-bs-toggle="tab" 
            data-bs-target="#workspaces" type="button">
      <i class="fas fa-cube"></i> Workspace ({{ workspaces|length }})
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="bots-tab" data-bs-toggle="tab" 
            data-bs-target="#bots" type="button">
      <i class="fas fa-robot"></i> Git –ë–æ—Ç—ã ({{ bots|length }})
    </button>
  </li>
</ul>

<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–º</h4>
  </div>
  <div>
    <a href="/server-console" class="btn btn-outline-primary">
      <i class="fas fa-terminal"></i> –ö–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞
    </a>
    <a href="/bots" class="btn btn-outline-secondary ms-2">
      <i class="fas fa-cogs"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏
    </a>
  </div>
</div>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–æ–≤ -->
<div class="tab-content">
  <!-- Workspace Tab -->
  <div class="tab-pane fade show active" id="workspaces" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Docker Workspace</h4>
      <a href="/workspace/create" class="btn btn-success">
        <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å Workspace
      </a>
    </div>
    
    {% if workspaces %}
      <div class="row">
        {% for ws in workspaces %}
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card card-bot h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">{{ ws.name }}</h6>
                <span class="status-indicator status-{{ 'running' if ws.status == 'running' else 'stopped' }}"></span>
              </div>
              <div class="card-body">
                <p class="text-muted mb-2">
                  <i class="fas fa-box"></i> {{ ws.image|truncate(40) }}
                </p>
                <p class="mb-2">
                  <span class="badge bg-{{ 'success' if ws.status == 'running' else 'secondary' }}">
                    {{ ws.status }}
                  </span>
                </p>
                {% if ws.has_workspace %}
                  <p class="text-success mb-2">
                    <i class="fas fa-check-circle"></i> –§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã
                  </p>
                {% endif %}
              </div>
              <div class="card-footer">
                <div class="btn-group w-100 mb-2" role="group">
                  {% if ws.status == 'running' %}
                    <a href="/terminal/{{ ws.name }}" class="btn btn-outline-primary btn-sm">
                      <i class="fas fa-terminal"></i> –¢–µ—Ä–º–∏–Ω–∞–ª
                    </a>
                  {% endif %}
                  <a href="/bot/{{ ws.name }}/commands" class="btn btn-outline-secondary btn-sm" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã">
                    <i class="fas fa-cog"></i> –ö–æ–º–∞–Ω–¥—ã
                  </a>
                </div>
                <div class="btn-group w-100" role="group">
                  <button class="btn btn-outline-success btn-sm act" data-name="{{ ws.name }}" data-act="start" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å">‚ñ∂</button>
                  <button class="btn btn-outline-warning btn-sm act" data-name="{{ ws.name }}" data-act="stop" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">‚ñ†</button>
                  <button class="btn btn-outline-info btn-sm act" data-name="{{ ws.name }}" data-act="restart" title="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å">‚Üª</button>
                  <div class="btn-group dropup">
                    <button class="btn btn-outline-danger btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="–£–¥–∞–ª–∏—Ç—å">
                      üóëÔ∏è
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item delete-workspace" data-name="{{ ws.name }}" data-files="false">
                        <i class="fas fa-stop-circle text-warning"></i> –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item delete-workspace text-danger" data-name="{{ ws.name }}" data-files="true">
                        <i class="fas fa-trash text-danger"></i> –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Ñ–∞–π–ª—ã
                      </a></li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-5">
        <i class="fas fa-cube fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö Workspace</h5>
        <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π workspace –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±–æ—Ç–∞</p>
        <a href="/workspace/create" class="btn btn-success">
          <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π Workspace
        </a>
      </div>
    {% endif %}
  </div>

  <!-- –ë–æ—Ç—ã –∏–∑ Git Tab -->
  <div class="tab-pane fade" id="bots" role="tabpanel">
    <h4>–ë–æ—Ç—ã –∏–∑ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤</h4>
    
    <div class="card mb-4 p-3">
      <form id="createBotForm" class="row g-2">
        <div class="col-md-4">
          <input class="form-control" name="git_url" placeholder="Git URL" required>
        </div>
        <div class="col-md-3">
          <input class="form-control" name="bot_name" placeholder="–ò–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        </div>
        <div class="col-md-2">
          <input class="form-control" name="branch" placeholder="Branch (–æ–ø—Ü.)">
        </div>
        <div class="col-md-2">
          <button class="btn btn-success w-100" type="submit">–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </form>
    </div>
    {% if bots %}
      <table class="table table-striped">
        <thead>
          <tr><th>–ò–º—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–±—Ä–∞–∑</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
        </thead>
        <tbody id="botsTbody">
          {% for b in bots %}
            <tr data-name="{{b.name}}">
              <td><a href="/terminal/{{b.name}}">{{ b.name }}</a></td>
              <td>
                <span class="badge bg-{{ 'success' if b.status == 'running' else 'secondary' }}">
                  {{ b.status }}
                </span>
              </td>
              <td>{{ b.image|truncate(40) }}</td>
              <td>
                <div class="btn-group btn-group-actions" role="group">
                  <button class="btn btn-sm btn-outline-success act" data-name="{{b.name}}" data-act="start">‚ñ∂</button>
                  <button class="btn btn-sm btn-outline-warning act" data-name="{{b.name}}" data-act="stop">‚ñ†</button>
                  <button class="btn btn-sm btn-outline-info act" data-name="{{b.name}}" data-act="restart">‚Üª</button>
                  <a href="/bot/{{b.name}}/commands" class="btn btn-sm btn-outline-secondary" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã">‚öôÔ∏è</a>
                  <button class="btn btn-sm btn-outline-danger act" data-name="{{b.name}}" data-act="remove">‚úñ</button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="text-center py-4">
        <i class="fas fa-robot fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">–ù–µ—Ç –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤</h5>
        <p class="text-muted">–ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞ –∏–∑ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è</p>
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –∏–∑ Git
document.getElementById('createBotForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const btn = e.target.querySelector('button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...';
  btn.disabled = true;
  
  const fd = new FormData(e.target);
  const obj = Object.fromEntries(fd.entries());
  
  try {
    const res = await fetch('/bots/create', {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(obj)
    });
    const data = await res.json();
    
    if(data.status==='ok') { 
      location.reload(); 
    } else { 
      alert('–û—à–∏–±–∫–∞: ' + data.error); 
    }
  } catch(err) {
    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è workspace
document.querySelectorAll('.delete-workspace').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    const name = btn.dataset.name;
    const deleteFiles = btn.dataset.files === 'true';
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ workspace –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    try {
      const infoRes = await fetch(`/workspace/${name}/info`);
      const infoData = await infoRes.json();
      
      if (infoData.status === 'ok') {
        const info = infoData.info;
        const filesCount = info.files_count || 0;
        const sizeKB = Math.round((info.directory_size || 0) / 1024);
        
        let confirmMessage = `–£–¥–∞–ª–∏—Ç—å workspace "${name}"?\n\n`;
        confirmMessage += `üìÅ –§–∞–π–ª–æ–≤: ${filesCount}\n`;
        confirmMessage += `üíæ –†–∞–∑–º–µ—Ä: ${sizeKB} KB\n\n`;
        
        if (deleteFiles) {
          confirmMessage += '‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –ù–ê–í–°–ï–ì–î–ê!\n';
          confirmMessage += '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!';
        } else {
          confirmMessage += '‚úÖ –§–∞–π–ª—ã workspace –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –ø–∞–ø–∫–µ bots/\n';
          confirmMessage += '–£–¥–∞–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.';
        }
        
        if (!confirm(confirmMessage)) return;
      }
    } catch (err) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å workspace "${name}"?`)) return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –£–¥–∞–ª–µ–Ω–∏–µ...';
    btn.style.pointerEvents = 'none';
    
    try {
      const res = await fetch(`/workspace/${name}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ delete_files: deleteFiles })
      });
      
      const data = await res.json();
      
      if (data.status === 'ok') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
          <i class="fas fa-check-circle"></i> ${data.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').prepend(alertDiv);
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => location.reload(), 2000);
      } else {
        alert('–û—à–∏–±–∫–∞: ' + data.error);
        btn.innerHTML = originalText;
        btn.style.pointerEvents = '';
      }
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
      btn.innerHTML = originalText;
      btn.style.pointerEvents = '';
    }
  });
});

// –î–µ–π—Å—Ç–≤–∏—è —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ (–±–æ—Ç—ã –∏ workspace)
document.querySelectorAll('.act').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const name = btn.dataset.name;
    const act = btn.dataset.act;
    
    if(act==='remove' && !confirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä "${name}"?\n\n–í–Ω–∏–º–∞–Ω–∏–µ: –î–∞–Ω–Ω—ã–µ workspace —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ bots/`)) return;
    
    const actionNames = {
      'start': '–ó–∞–ø—É—Å–∫',
      'stop': '–û—Å—Ç–∞–Ω–æ–≤–∫–∞', 
      'restart': '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞',
      'remove': '–£–¥–∞–ª–µ–Ω–∏–µ'
    };
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–ø–æ–ª–Ω—è–µ–º–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
    const actionName = actionNames[act] || act;
    showCommandNotification(`üîÑ ${actionName} "${name}"...`, 'info');
    
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.disabled = true;
    
    try {
      const res = await fetch(`/bots/${name}/${act}`, {method:'POST'});
      const data = await res.json();
      
      if(data.status==='ok') { 
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π, –µ—Å–ª–∏ –µ—Å—Ç—å
        let message = `‚úÖ ${actionName} "${name}" –≤—ã–ø–æ–ª–Ω–µ–Ω`;
        if(data.command) {
          message += `\n\nüíª –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞:\n${data.command}`;
        }
        if(data.output) {
          message += `\n\nüìÑ –í—ã–≤–æ–¥:\n${data.output}`;
        }
        showCommandNotification(message, 'success');
        setTimeout(() => location.reload(), 1500);
      } else { 
        showCommandNotification(`‚ùå –û—à–∏–±–∫–∞ ${actionName.toLowerCase()}: ${data.error}`, 'danger');
      }
    } catch(err) {
      showCommandNotification(`üî¥ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${err.message}`, 'danger');
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∫–æ–º–∞–Ω–¥–∞—Ö
function showCommandNotification(message, type = 'info') {
  // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
  let container = document.getElementById('command-notifications');
  if (!container) {
    container = document.createElement('div');
    container.id = 'command-notifications';
    container.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
    `;
    document.body.appendChild(container);
  }
  
  // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show`;
  notification.style.cssText = `
    margin-bottom: 10px;
    white-space: pre-line;
    font-family: monospace;
    font-size: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  container.appendChild(notification);
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (–∫—Ä–æ–º–µ –æ—à–∏–±–æ–∫)
  if (type !== 'danger') {
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
document.addEventListener('DOMContentLoaded', function() {
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏–∑ localStorage
  const activeTab = localStorage.getItem('activeTab');
  if(activeTab) {
    const tabElement = document.querySelector(`#${activeTab}-tab`);
    if(tabElement) {
      const tab = new bootstrap.Tab(tabElement);
      tab.show();
    }
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
  document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function(e) {
      const tabId = e.target.id.replace('-tab', '');
      localStorage.setItem('activeTab', tabId);
    });
  });
});
</script>
{% endblock %}