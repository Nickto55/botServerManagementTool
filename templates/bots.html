{% extends 'layout.html' %}
{% block content %}

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-robot"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏</h2>
    <div>
      <button class="btn btn-primary me-2" onclick="refreshBots()">
        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
      </button>
      <a href="/" class="btn btn-secondary">
        <i class="fas fa-home"></i> Dashboard
      </a>
    </div>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" class="form-control" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
        </div>
        <div class="col-md-3">
          <select class="form-select" id="statusFilter">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="running">–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ</option>
            <option value="exited">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ</option>
            <option value="created">–°–æ–∑–¥–∞–Ω–Ω—ã–µ</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" id="typeFilter">
            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
            <option value="bot">–ë–æ—Ç—ã</option>
            <option value="workspace">Workspace</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
            <i class="fas fa-times"></i> –°–±—Ä–æ—Å
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –±–æ—Ç–æ–≤ -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="botsTable">
          <thead>
            <tr>
              <th>–ò–º—è</th>
              <th>–¢–∏–ø</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–û–±—Ä–∞–∑</th>
              <th>CPU</th>
              <th>–ü–∞–º—è—Ç—å</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="botsTableBody">
            <!-- –ë–æ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ª–æ–≥–æ–≤ -->
<div class="modal fade" id="logsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-file-alt"></i> –õ–æ–≥–∏: <span id="logsModalTitle"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:</label>
          <select class="form-select" id="logsTail" style="width: auto; display: inline-block;">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
          </select>
          <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadLogs()">
            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>
        <pre id="logsContent" class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto; font-size: 12px;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
<div class="modal fade" id="infoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: <span id="infoModalTitle"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="infoContent">
          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ -->
<div class="modal fade" id="execModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-terminal"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É: <span id="execModalTitle"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ö–æ–º–∞–Ω–¥–∞:</label>
          <input type="text" class="form-control" id="execCommand" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è">
        </div>
        <div class="mb-3">
          <label class="form-label">–†–µ–∑—É–ª—å—Ç–∞—Ç:</label>
          <pre id="execOutput" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-size: 12px;"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button type="button" class="btn btn-primary" onclick="executeCommand()">
          <i class="fas fa-play"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allBots = [];
let currentBotName = '';

async function loadBots() {
  try {
    const response = await fetch('/api/bots');
    const data = await response.json();
    
    if (data.status === 'ok') {
      allBots = data.containers;
      renderBots();
    } else {
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–æ–≤: ' + data.error, 'danger');
    }
  } catch (error) {
    showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'danger');
  }
}

function renderBots() {
  const tbody = document.getElementById('botsTableBody');
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const statusFilter = document.getElementById('statusFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  
  const filteredBots = allBots.filter(bot => {
    const matchesSearch = bot.name.toLowerCase().includes(searchTerm);
    const matchesStatus = !statusFilter || bot.status === statusFilter;
    const matchesType = !typeFilter || bot.type === typeFilter;
    return matchesSearch && matchesStatus && matchesType;
  });
  
  tbody.innerHTML = '';
  
  if (filteredBots.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><i class="fas fa-robot fa-2x text-muted mb-2"></i><br>–ù–µ—Ç –±–æ—Ç–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º</td></tr>';
    return;
  }
  
  filteredBots.forEach(bot => {
    const statusClass = bot.status === 'running' ? 'success' : 
                       bot.status === 'exited' ? 'secondary' : 'warning';
    const statusIcon = bot.status === 'running' ? '‚ñ∂' : 
                      bot.status === 'exited' ? '‚ñ†' : '‚è∏';
    
    const cpuPercent = bot.cpu_percent !== undefined ? `${bot.cpu_percent}%` : '-';
    const memoryPercent = bot.memory_percent !== undefined ? `${bot.memory_percent}%` : '-';
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <strong>${bot.name}</strong>
        <br><small class="text-muted">${bot.id}</small>
      </td>
      <td>
        <span class="badge bg-${bot.type === 'workspace' ? 'info' : 'primary'}">
          ${bot.type === 'workspace' ? 'Workspace' : '–ë–æ—Ç'}
        </span>
      </td>
      <td>
        <span class="badge bg-${statusClass}">
          ${statusIcon} ${bot.status}
        </span>
      </td>
      <td>
        <code>${bot.image}</code>
      </td>
      <td>${cpuPercent}</td>
      <td>${memoryPercent}</td>
      <td>
        <div class="btn-group btn-group-sm" role="group">
          ${bot.status === 'running' ? 
            `<button class="btn btn-outline-warning" onclick="botAction('${bot.name}', 'stop')" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">
              <i class="fas fa-stop"></i>
            </button>
            <button class="btn btn-outline-info" onclick="botAction('${bot.name}', 'restart')" title="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å">
              <i class="fas fa-redo"></i>
            </button>` :
            `<button class="btn btn-outline-success" onclick="botAction('${bot.name}', 'start')" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å">
              <i class="fas fa-play"></i>
            </button>`
          }
          <button class="btn btn-outline-primary" onclick="showLogs('${bot.name}')" title="–õ–æ–≥–∏">
            <i class="fas fa-file-alt"></i>
          </button>
          <button class="btn btn-outline-secondary" onclick="showInfo('${bot.name}')" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
            <i class="fas fa-info-circle"></i>
          </button>
          <a href="/bot/${bot.name}/commands" class="btn btn-outline-warning btn-sm" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥">
            <i class="fas fa-cog"></i>
          </a>
          <button class="btn btn-outline-dark" onclick="showExec('${bot.name}')" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É">
            <i class="fas fa-terminal"></i>
          </button>
          <button class="btn btn-outline-danger" onclick="botAction('${bot.name}', 'remove')" title="–£–¥–∞–ª–∏—Ç—å">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

async function botAction(name, action) {
  const actionNames = {
    'start': '–ó–∞–ø—É—Å–∫',
    'stop': '–û—Å—Ç–∞–Ω–æ–≤–∫–∞',
    'restart': '–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫',
    'remove': '–£–¥–∞–ª–µ–Ω–∏–µ'
  };
  
  if (action === 'remove' && !confirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä "${name}"?\n\n–í–Ω–∏–º–∞–Ω–∏–µ: –î–∞–Ω–Ω—ã–µ workspace —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ bots/`)) {
    return;
  }
  
  showAlert(`üîÑ ${actionNames[action]} "${name}"...`, 'info');
  
  try {
    const response = await fetch(`/bots/${name}/${action}`, { method: 'POST' });
    const data = await response.json();
    
    if (data.status === 'ok') {
      showAlert(`‚úÖ ${actionNames[action]} "${name}" –≤—ã–ø–æ–ª–Ω–µ–Ω`, 'success');
      setTimeout(() => loadBots(), 1000);
    } else {
      showAlert(`‚ùå –û—à–∏–±–∫–∞ ${actionNames[action].toLowerCase()}: ${data.error}`, 'danger');
    }
  } catch (error) {
    showAlert(`üî¥ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'danger');
  }
}

function showLogs(name) {
  currentBotName = name;
  document.getElementById('logsModalTitle').textContent = name;
  const modal = new bootstrap.Modal(document.getElementById('logsModal'));
  modal.show();
  loadLogs();
}

async function loadLogs() {
  const tail = document.getElementById('logsTail').value;
  document.getElementById('logsContent').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...';
  
  try {
    const response = await fetch(`/api/bot/${currentBotName}/logs?tail=${tail}`);
    const data = await response.json();
    
    if (data.status === 'ok') {
      document.getElementById('logsContent').textContent = data.logs || '–õ–æ–≥–∏ –ø—É—Å—Ç—ã–µ';
    } else {
      document.getElementById('logsContent').textContent = '–û—à–∏–±–∫–∞: ' + data.error;
    }
  } catch (error) {
    document.getElementById('logsContent').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
  }
}

function showInfo(name) {
  currentBotName = name;
  document.getElementById('infoModalTitle').textContent = name;
  const modal = new bootstrap.Modal(document.getElementById('infoModal'));
  modal.show();
  loadInfo();
}

async function loadInfo() {
  document.getElementById('infoContent').innerHTML = '<div class="text-center"><div class="spinner-border"></div> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  try {
    const response = await fetch(`/api/bot/${currentBotName}/info`);
    const data = await response.json();
    
    if (data.status === 'ok') {
      const info = data.info;
      let html = '<div class="row">';
      
      if (info.error) {
        html = `<div class="alert alert-danger">${info.error}</div>`;
      } else {
        html += `
          <div class="col-md-6">
            <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
            <table class="table table-sm">
              <tr><td><strong>ID:</strong></td><td><code>${info.id}</code></td></tr>
              <tr><td><strong>–ò–º—è:</strong></td><td>${info.name}</td></tr>
              <tr><td><strong>–°—Ç–∞—Ç—É—Å:</strong></td><td><span class="badge bg-${info.status === 'running' ? 'success' : 'secondary'}">${info.status}</span></td></tr>
              <tr><td><strong>–û–±—Ä–∞–∑:</strong></td><td><code>${info.image}</code></td></tr>
              <tr><td><strong>–°–æ–∑–¥–∞–Ω:</strong></td><td>${new Date(info.created).toLocaleString()}</td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6>–†–µ—Å—É—Ä—Å—ã</h6>
            <table class="table table-sm">
              <tr><td><strong>CPU:</strong></td><td>${info.cpu_percent !== undefined ? info.cpu_percent + '%' : '–ù/–î'}</td></tr>
              <tr><td><strong>–ü–∞–º—è—Ç—å:</strong></td><td>${info.memory_percent !== undefined ? info.memory_percent + '%' : '–ù/–î'}</td></tr>
              <tr><td><strong>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</strong></td><td>${formatBytes(info.memory_usage)} / ${formatBytes(info.memory_limit)}</td></tr>
            </table>
            
            <h6>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h6>
            <table class="table table-sm">
              <tr><td><strong>–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:</strong></td><td><code>${info.working_dir || '–ù/–î'}</code></td></tr>
              <tr><td><strong>–ö–æ–º–∞–Ω–¥–∞:</strong></td><td><code>${Array.isArray(info.command) ? info.command.join(' ') : info.command || '–ù/–î'}</code></td></tr>
              <tr><td><strong>–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫:</strong></td><td>${info.restart_policy || 'no'}</td></tr>
            </table>
          </div>
        `;
      }
      
      html += '</div>';
      document.getElementById('infoContent').innerHTML = html;
    } else {
      document.getElementById('infoContent').innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞: ' + data.error + '</div>';
    }
  } catch (error) {
    document.getElementById('infoContent').innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message + '</div>';
  }
}

function showExec(name) {
  currentBotName = name;
  document.getElementById('execModalTitle').textContent = name;
  document.getElementById('execCommand').value = '';
  document.getElementById('execOutput').textContent = '';
  const modal = new bootstrap.Modal(document.getElementById('execModal'));
  modal.show();
}

async function executeCommand() {
  const command = document.getElementById('execCommand').value.trim();
  if (!command) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É');
    return;
  }
  
  document.getElementById('execOutput').textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã...';
  
  try {
    const response = await fetch(`/api/bot/${currentBotName}/exec`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ command: command })
    });
    
    const data = await response.json();
    
    if (data.status === 'ok') {
      document.getElementById('execOutput').textContent = 
        `Exit code: ${data.exit_code}\n\n${data.output}`;
    } else {
      document.getElementById('execOutput').textContent = '–û—à–∏–±–∫–∞: ' + data.error;
    }
  } catch (error) {
    document.getElementById('execOutput').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
  }
}

function refreshBots() {
  loadBots();
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('typeFilter').value = '';
  renderBots();
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type = 'info') {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  const container = document.querySelector('.container-fluid');
  container.insertBefore(alertDiv, container.firstChild);
  
  setTimeout(() => {
    alertDiv.remove();
  }, 5000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
  loadBots();
  
  // –§–∏–ª—å—Ç—Ä—ã
  document.getElementById('searchInput').addEventListener('input', renderBots);
  document.getElementById('statusFilter').addEventListener('change', renderBots);
  document.getElementById('typeFilter').addEventListener('change', renderBots);
  
  // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  setInterval(loadBots, 30000);
});
</script>

{% endblock %}